---
- name: Create user
  remote_user: devops
  become: yes
  user:
    name: "{{ item.0.user }}"
    shell: /bin/bash
    groups:
       - docker
       - devops
    append: yes
    file: dest=/home/"{{ item.0.user }}"/.ssh owner="{{ item.0.user }}" group="{{ item.0.user }}" mode=0700 recurse=yes
  loop: "{{ usernames | subelements('sshkey', 'skip_missing=True') }}"

- name: Add users ssh public key
  remote_user: devops
  become: yes
  authorized_key:
    user: "{{ item.0.user }}"
    state: present
    key: "{{ item.1 }}"
  loop: "{{ usernames | subelements('sshkey', 'skip_missing=True') }}"


